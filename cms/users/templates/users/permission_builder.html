{% extends "medexCms/shared/base.html" %}
{% load sass_tags %}
{% load staticfiles %}

{% block extra_css %}
  <link href="{% sass_src 'scss/users/permissions.scss' %}" rel="stylesheet" type="text/css" >
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/shared/search-dropdown.js' %}"></script>
  <script src="{% static 'js/users/permission-builder.js' %}"></script>
{% endblock %}

{% block page %}
  <div class="permission-builder-page">
    {% if managed_user %}
      {% if invalid %}
          <div class="nhsuk-error-summary " id="error_alert" aria-labelledby="error-summary-title" role="alert"
               tabindex="-1">
              <h2 class="nhsuk-error-summary__title" id="error-summary-title">
                  There is a problem
              </h2>
              <div class="nhsuk-error-summary__body">
                  <p>
                      Please correct the errors in this form
                  </p>
              </div>
          </div>
      {% endif %}

      <h1 class="page-title">
        {% if managed_user.firstname %}
          {{ managed_user.fullname }}
        {% else %}
          {{ managed_user.email_address }}
        {% endif %}
      </h1>

      <h2 class="page-subheading">
        {{ sub_heading}}
      </h2>

      <form id="permission-builder-form" class="form{% if invalid %} error{% endif %}" action="{% url submit_path user_id=managed_user.user_id %}" method="post">
        {% csrf_token %}

        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-two-thirds">
            <div class="nhsuk-form-group {% if form.role_error %}nhsuk-form-group--error{% endif %}">

              <fieldset id='role-radio-buttons' class="nhsuk-fieldset">
                <legend class="nhsuk-fieldset__legend">
                  What role will the user be performing?
                </legend>

                {% if form.role_error %}
                  <span class="nhsuk-error-message medex-font-default-override">{{ form.role_error }}</span>
                {% endif %}

                <div class="nhsuk-radios">
                  <div class="nhsuk-grid-row">
                    <div class="nhsuk-grid-column-one-half">
                      <div class="nhsuk-radios__item">
                        <input class="nhsuk-radios__input {% if form.role_error %}nhsuk-input--error{% endif %}"
                            id="role-1" name="role" type="radio" value="1" {% if form.role == '1' %}checked{% endif %}>
                        <label class="nhsuk-label nhsuk-radios__label" for="role-1">
                          ME
                        </label>
                      </div>

                      <div class="nhsuk-radios__item">
                        <input class="nhsuk-radios__input {% if form.role_error %}nhsuk-input--error{% endif %}"
                             id="role-2" name="role" type="radio" value="0" {% if form.role == '0' %}checked{% endif %}>
                        <label class="nhsuk-label nhsuk-radios__label" for="role-2">
                          MEO
                        </label>
                      </div>
                    </div>

                    <div class="nhsuk-grid-column-one-half">
                      <div class="nhsuk-radios__item">
                        <input class="nhsuk-radios__input {% if form.role_error %}nhsuk-input--error{% endif %}"
                             id="role-3" name="role" type="radio" value="2" {% if form.role == '2' %}checked{% endif %}>
                        <label class="nhsuk-label nhsuk-radios__label" for="role-3">
                          System admin only
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </div>

        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-two-thirds">
            <div class="nhsuk-form-group {% if form.permission_level_error %}nhsuk-form-group--error{% endif %}">
              <fieldset id="level-radio-buttons" class="nhsuk-fieldset">
                <legend class="nhsuk-fieldset__legend">
                    What permission level do they need?
                </legend>

                {% if form.permission_level_error %}
                  <span class="nhsuk-error-message medex-font-default-override">{{ form.permission_level_error }}</span>
                {% endif %}

                <div class="nhsuk-radios">
                  <div class="nhsuk-radios__item">
                    <input class="nhsuk-radios__input {% if form.permission_level_error %}nhsuk-input--error{% endif %}"
                         id="level-1" name="permission_level" type="radio" value="national" {% if form.permission_level == 'national' %}checked{% endif %}>
                    <label class="nhsuk-label nhsuk-radios__label" for="level-1">
                      National
                    </label>
                  </div>

                  <div class="nhsuk-radios__item">
                    <input class="nhsuk-radios__input {% if form.permission_level_error %}nhsuk-input--error{% endif %}"
                         id="level-2" name="permission_level" type="radio" value="regional" {% if form.permission_level == 'regional' %}checked{% endif %}>
                    <label class="nhsuk-label nhsuk-radios__label" for="level-2">
                      Regional
                    </label>
                  </div>
                    <div class="nhsuk-radios__item">
                      <input class="nhsuk-radios__input {% if form.permission_level_error %}nhsuk-input--error{% endif %}"
                           id="level-3" name="permission_level" type="radio" value="trust" {% if form.permission_level == 'trust' %}checked{% endif %}>
                      <label class="nhsuk-label nhsuk-radios__label" for="level-3">
                        Trust
                      </label>
                    </div>
                  </div>
              </fieldset>
            </div>
          </div>
        </div>

        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-full">
            <div id="region-selector" class="nhsuk-form-group {% if form.region_error %}nhsuk-form-group--error{% endif %}">
              <label class="nhsuk-label" for="region">
                Region and associated NHS Trusts/ME Offices
              </label>

              {% if form.region_error %}
                <span class="nhsuk-error-message medex-font-default-override">{{ errors.region_error }}</span>
              {% endif %}

              <select class="nhsuk-select" id="region" name="region" value="{{ form.region }}">
                <option value="" disabled hidden selected>Select an region</option>
                {% for region in regions %}
                  <option value="{{ region.location_id }}" {% if region.location_id == form.region %}selected{% endif %}>{{ region.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-full">
            <div id='trust-selector' class="nhsuk-form-group {% if form.trust_error %}nhsuk-form-group--error{% endif %}">
              <label class="nhsuk-label" for="trust">
                Trust
              </label>

              {% if form.trust_error %}
                <span class="nhsuk-error-message medex-font-default-override">{{ form.trust_error }}</span>
              {% endif %}

              <div class="search-dropdown">
                <input id="trust" class='selection-field' type="text" name="trust" value="{{form.trust}}">
                <div class='search-field{% if form.trust_error %} error{% endif %}'>
                  <input type="text" name="searchField" placeholder="Search for a trust">
                </div>
                <div class="options-list">
                  <p class="placeholder options-list--placeholder">Please enter at least 3 characters to search</p>
                  {% for trust in trusts %}
                    <option value="{{trust.location_id}}">{{trust.name}}</option>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <input type="text" name="add_another" value="false" hidden>

        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-full">
            <input id="submit-btn" class="nhsuk-button" type="submit" value="{{form.submit_btn_text}}"/>
          </div>
        </div>

        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-full">
            <button id="add-another" class="nhsuk-button nhsuk-button--secondary">Save and add another permission</button>
          </div>
        </div>
      </form>
    {% else %}
      {% for alert in alerts %}
        {% include 'alerts/partials/_alert.html' %}
      {% endfor %}
    {% endif %}
  </div>
{% endblock %}